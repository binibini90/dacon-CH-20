<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI ì—¬í–‰ í”Œë˜ë„ˆ ì±—ë´‡</title>
<style>
  :root{
    --w: 380px; --h: 600px;
    --radius: 16px; --gap: 10px;
    --bg: #ffffff; --line:#eaeaea; --text:#1f2937;
    --bot:#f7f7fb; --user:#e8f0ff; --brand:#6b7cff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,"Malgun Gothic",sans-serif}
  .fab{
    position:fixed; right:22px; bottom:22px; width:56px; height:56px;
    border-radius:50%; background:var(--brand); color:#fff; border:none;
    box-shadow:0 10px 24px rgba(0,0,0,.15); cursor:pointer; font-size:22px;
  }
  .panel{
    position:fixed; right:22px; bottom:90px; width:var(--w); height:var(--h);
    border:1px solid var(--line); background:var(--bg); border-radius:var(--radius);
    box-shadow:0 18px 48px rgba(0,0,0,.18); display:none;
    overflow:hidden; backdrop-filter:saturate(1.2);
  }
  .panel.open{display:flex; flex-direction:column}
  .head{
    height:56px; display:flex; align-items:center; padding:0 14px; gap:10px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,#f8f9ff,#fff);
  }
  .dot{width:8px;height:8px;border-radius:50%;background:#4ade80}
  .title{font-weight:700}
  .close{margin-left:auto; background:none;border:none;font-size:20px; cursor:pointer; color:#667085}
  .msgs{flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:12px; background:#fafafa}
  .bubble{max-width:78%; padding:10px 12px; border-radius:14px; line-height:1.35; color:var(--text); white-space:pre-wrap}
  .bot{align-self:flex-start; background:var(--bot); border:1px solid #efefef}
  .user{align-self:flex-end; background:var(--user); border:1px solid #dfe8ff}
  .syscard{align-self:flex-start; background:#fff; border:1px solid var(--line); border-left:4px solid var(--brand); padding:12px; border-radius:12px; color:#334155}
  .typing{font-size:12px; color:#667085; padding:0 2px 6px 2px}
  .input{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line); background:#fff;}
  .input input{flex:1; padding:12px 12px; border:1px solid var(--line); border-radius:12px; outline:none;}
  .input button{padding:0 14px; border:none; border-radius:12px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer;}
  .card{border:1px solid var(--line); background:#fff; border-radius:12px; padding:10px 12px;}
  .card h4{margin:2px 0 8px; font-size:14px}
  .seg{display:flex; gap:8px; font-size:13px; border-top:1px dashed #eee; padding-top:6px; margin-top:6px}
  .seg time{width:66px; color:#6b7280}
  .seg .ttl{font-weight:600}
  @media (max-width: 480px){
    :root{--w: 95vw; --h: 70vh;}
    .panel{right:10px; bottom:86px}
  }
</style>
</head>
<body>

<button class="fab" id="fab">ğŸ’¬</button>

<div class="panel" id="panel" aria-label="AI ì—¬í–‰ í”Œë˜ë„ˆ">
  <div class="head">
    <span class="dot"></span><div class="title">AI ì—¬í–‰ í”Œë˜ë„ˆ</div>
    <button class="close" id="close" aria-label="ë‹«ê¸°">âœ•</button>
  </div>
  <div class="msgs" id="msgs">
    <div class="syscard">
      ì•ˆë…•í•˜ì„¸ìš”! ì›í•˜ëŠ” ì¥ì†Œ/ìŒì‹ì /ë‚ ì§œë¥¼ ë§ì”€í•´ ì£¼ì„¸ìš”.<br>
      ì˜ˆ) â€œ11/20~21, ê´‘ì¥ì‹œì¥Â·ëª…ë™êµì ê¼­ ê°€ê³  ê²½ë³µê¶/ë‚¨ì‚°ë„ ë„£ì–´ì¤˜â€
    </div>
  </div>
  <div class="input">
    <input id="m" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="send">ì „ì†¡</button>
  </div>
</div>

<script>
/** â–£ API ì£¼ì†Œ ìë™ ì„¤ì • -----------------------------------------------
 *  - ê¸°ë³¸: í˜„ì¬ í˜ì´ì§€ì™€ ë™ì¼í•œ í”„ë¡œí† ì½œ + í˜¸ìŠ¤íŠ¸ì— í¬íŠ¸ë§Œ 8000ìœ¼ë¡œ
 *  - ?api=URL ì¿¼ë¦¬ë¡œ ê°•ì œ ì§€ì • ê°€ëŠ¥(ì˜ˆ: chatbot.html?api=http://127.0.0.1:8000)
 */
function getParam(name){ return new URL(location.href).searchParams.get(name); }
const forced = getParam('api');
const proto  = location.protocol;                   // http: or https:
const host   = location.hostname;                   // 127.0.0.1 / localhost / ë„ë©”ì¸
const API_BASE = forced || `${proto}//${host}:8000`;
const CHAT_URL = API_BASE + "/chat";

/** â–£ ì—˜ë¦¬ë¨¼íŠ¸ */
const fab = document.getElementById('fab');
const panel = document.getElementById('panel');
const closeBtn = document.getElementById('close');
const msgs = document.getElementById('msgs');
const sendBtn = document.getElementById('send');
const input = document.getElementById('m');

let history = [];
let sending = false;

fab.onclick = () => panel.classList.add('open');
closeBtn.onclick = () => panel.classList.remove('open');

/* í˜ì´ì§€ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ ì—´ê¸°(ì›ì¹˜ ì•Šìœ¼ë©´ ì£¼ì„ì²˜ë¦¬) */
window.addEventListener('load', ()=> panel.classList.add('open'));

function addBubble(who, html){
  const d = document.createElement('div');
  d.className = 'bubble ' + who;
  d.innerHTML = html;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}
function addTyping(){
  if (document.getElementById('typing')) return;
  const t = document.createElement('div');
  t.className = 'typing'; t.id = 'typing';
  t.textContent = 'ì‘ë‹µ ì‘ì„± ì¤‘...';
  msgs.appendChild(t);
  msgs.scrollTop = msgs.scrollHeight;
}
function removeTyping(){
  const t = document.getElementById('typing');
  if (t) t.remove();
}
function esc(s){ return s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

function renderItinerary(it){
  const wrap = document.createElement('div'); wrap.className = 'card';
  wrap.innerHTML = `<h4>ì¶”ì²œ ì½”ìŠ¤</h4>`;
  (it.days||[]).forEach(day=>{
    const h = document.createElement('div');
    h.innerHTML = `<div style="font-weight:700; margin:6px 0;">ğŸ“… ${day.date}</div>`;
    wrap.appendChild(h);
    (day.segments||[]).forEach(seg=>{
      const row = document.createElement('div'); row.className = 'seg';
      const t1 = seg.time_start || ''; const t2 = seg.time_end || '';
      const ttl = seg.title || '';
      const note = seg.note ? `<div style="color:#6b7280">${esc(seg.note)}</div>` : '';
      row.innerHTML = `<time>${t1}~${t2}</time><div><div class="ttl">${esc(ttl)}</div>${note}</div>`;
      wrap.appendChild(row);
    });
  });
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

async function send(){
  if(sending) return;
  const text = input.value.trim();
  if(!text) return;
  sending = true;
  input.disabled = true; sendBtn.disabled = true;

  addBubble('user', esc(text));
  input.value = ""; addTyping();

  try{
    const r = await fetch(CHAT_URL, {
      method:'POST',
      headers:{
        'Content-Type':'application/json'
      },
      body: JSON.stringify({ message: text, history })
    });

    // HTTP ì—ëŸ¬ ì²˜ë¦¬
    if(!r.ok){
      const errText = await r.text();
      removeTyping();
      addBubble('bot', `ì„œë²„ ì˜¤ë¥˜(${r.status}).\nURL: ${CHAT_URL}\në©”ì‹œì§€: ${esc(errText.slice(0,300))}`);
      return;
    }

    const data = await r.json();
    removeTyping();

    if (data.type === 'itinerary_v1') {
      if (data.summary) addBubble('bot', esc(data.summary));
      renderItinerary(data);
      history.push({role:'assistant', content: JSON.stringify(data)});
    } else {
      const t = data.text || (typeof data === 'string' ? data : JSON.stringify(data));
      addBubble('bot', esc(t));
      history.push({role:'assistant', content: t});
    }
    history.push({role:'user', content: text});
  } catch(e){
    removeTyping();
    addBubble('bot', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${esc(String(e))}\nAPI: ${CHAT_URL}`);
    console.error(e);
  } finally {
    sending = false;
    input.disabled = false; sendBtn.disabled = false;
    input.focus();
  }
}

sendBtn.onclick = send;
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
</script>
</body>
</html>
